<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />

  <title>Before You Sign - Verified Vehicles</title>
  <%- include('../partials/favicon.ejs') %>
  <!-- 
    - favicon
  -->
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!-- 
    - custom css link
  -->
  <link rel="stylesheet" href="/css/vehicles.css">

  <!-- 
    - google font link
  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&family=Open+Sans&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>

</head>

<body>
  <header class="header" data-header>
    <div class="container">

      <div class="overlay" data-overlay></div>
      <style>
        .nav__logo__img {
          width: 40px;
          height: auto;
        }
      </style>
      <a href="/" class="logo">
        <img src="/assets/logo.png" alt="Logo" class="nav__logo__img">
      </a>

      <nav class="navbar" data-navbar>
        <ul class="navbar-list">

          <li>
            <a href="/" class="navbar-link" data-nav-link>Home</a>
          </li>

          <li>
            <a href="#featured-car" class="navbar-link" data-nav-link>Browse Vehicles</a>
          </li>

          <li>
            <a href="#" class="navbar-link" data-nav-link>About us</a>
          </li>

          <li>
            <a href="#blog" class="navbar-link" data-nav-link>Blog</a>
          </li>

        </ul>
      </nav>

      <div class="header-actions">
        <button class="nav-toggle-btn" data-nav-toggle-btn aria-label="Toggle Menu">
          <span class="one"></span>
          <span class="two"></span>
          <span class="three"></span>
        </button>

      </div>

    </div>
  </header>

  <main>
    <article>
      <section class="section hero" id="home">
        <div class="container" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">

          <div class="hero-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <h2 class="h1 hero-title">Search & Find Your Next Verified Vehicle</h2>

            <p class="hero-text">
              Browse our selection of certified vehicles with complete verified histories from ethical dealerships
            </p>
          </div>

          <div class="hero-form" style="display: flex; justify-content: center; align-items: center; width: 50%;">
            <button id="scanQrBtn" class="btn" type="button" style="border-radius: 0.5rem; padding: 12px 24px;">
              <i class="ri-qr-scan-2-line"></i> Scan QR
            </button>
          </div>


          <div id="qrModal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.8);">
            <div style="max-width:500px; margin:40px auto; background:#fff; border-radius:12px; padding:30px; position:relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:#1f2937;">
                  <i class="ri-qr-scan-2-line" style="color:var(--primary); margin-right:10px;"></i>
                  Scan Vehicle QR Code
                </h3>
                <button onclick="closeQrModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#6b7280;">
                  ×
                </button>
              </div>
              
              <div id="qr-reader" style="width:100%; max-width:400px; margin:0 auto;"></div>
              
              <div id="qr-status" style="margin-top:15px; padding:12px; background:#f3f4f6; border-radius:6px; color:#374151; font-size:0.9rem; display:none;">
                Initializing camera...
              </div>
              
              <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="closeQrModal()" class="btn btn-secondary" style="flex:1;">
                  <i class="ri-close-line"></i> Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 
        - #FEATURED CAR
      -->
      <section class="section featured-car" id="featured-car">
        <div class="container">

          <div class="title-wrapper">
            <h2 class="h2 section-title">Verified Vehicles</h2>

            <div class="results-count">
              Showing <%= vehicles.length %> vehicle<%= vehicles.length !== 1 ? 's' : '' %>
            </div>
          </div>

          <% if (vehicles.length === 0) { %>
            <div style="text-align: center; padding: 3rem; color: #6b7280;">
              <ion-icon name="search-outline" style="font-size: 3rem; margin-bottom: 1rem;"></ion-icon>
              <h3>No vehicles found</h3>
              <p>Try adjusting your search criteria or filters</p>
              <a href="/vehicles" class="btn" style="margin-top: 1rem;">Clear Filters</a>
            </div>
          <% } else { %>
            <ul class="featured-car-list">
              <% vehicles.forEach(function(vehicle) { %>
                <li>
                  <div class="featured-car-card">

                    <figure class="card-banner">
                      <img src="https://www.svgrepo.com/show/325741/verified-badge.svg" 
                        alt="<%= vehicle.make %> <%= vehicle.model %>" loading="lazy" width="440" height="300"
                        class="w-100"
                      >
                      <div style="position: absolute; top: 10px; left: 10px; background: #00a859; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <ion-icon name="shield-checkmark-outline"></ion-icon> Verified
                      </div>
                    </figure>

                    <div class="card-content">

                      <div class="card-title-wrapper">
                        <h3 class="h3 card-title">
                          <a href="/vehicle/<%= vehicle.id %>"><%= vehicle.make %> <%= vehicle.model %></a>
                        </h3>

                        <data class="year" value="<%= vehicle.year %>"><%= vehicle.year %></data>
                      </div>

                      <ul class="card-list">

                        <li class="card-list-item">
                          <ion-icon name="speedometer-outline"></ion-icon>

                          <span class="card-item-text"><%= vehicle.mileage ? vehicle.mileage.toLocaleString() + ' km' : 'N/A' %></span>
                        </li>

                        <li class="card-list-item">
                          <ion-icon name="flash-outline"></ion-icon>

                          <span class="card-item-text"><%= vehicle.fuel_type || 'N/A' %></span>
                        </li>

                        <li class="card-list-item">
                          <ion-icon name="hardware-chip-outline"></ion-icon>

                          <span class="card-item-text"><%= vehicle.transmission || 'N/A' %></span>
                        </li>

                        <li class="card-list-item">
                          <ion-icon name="business-outline"></ion-icon>

                          <span class="card-item-text"><%= vehicle.business_name %></span>
                        </li>

                      </ul>

                      <div class="card-price-wrapper">

                        <!-- <p class="card-price">
                          <p style="color: #00a859;"><i class="fa-solid fa-certificate"></i> Verified</p>
                        </p> -->

                        <a href="">
                          <button class="btn fav-btn" aria-label="Add to favourite list" style="display: flex;">
                            <i class="fa-solid fa-globe"></i> Visit Web
                          </button>
                        </a>

                        <a href="/vehicle/<%= vehicle.id %>" class="btn">View Details</a>

                      </div>

                    </div>

                  </div>
                </li>
              <% }); %>
            </ul>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
              <div class="pagination" style="display: flex; justify-content: center; margin-top: 3rem; gap: 0.5rem;">
                <% if (currentPage > 1) { %>
                  <a href="/vehicles?page=<%= currentPage - 1 %><%= filters.make ? '&make=' + filters.make : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %><%= filters.bodyType ? '&bodyType=' + filters.bodyType : '' %>" 
                     class="btn" style="padding: 0.5rem 1rem;">Previous</a>
                <% } %>

                <% for (let i = 1; i <= totalPages; i++) { %>
                  <% if (i === currentPage) { %>
                    <span class="btn" style="background: #000; color: white; padding: 0.5rem 1rem;"><%= i %></span>
                  <% } else { %>
                    <a href="/vehicles?page=<%= i %><%= filters.make ? '&make=' + filters.make : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %><%= filters.bodyType ? '&bodyType=' + filters.bodyType : '' %>" 
                       class="btn" style="padding: 0.5rem 1rem;"><%= i %></a>
                  <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                  <a href="/vehicles?page=<%= currentPage + 1 %><%= filters.make ? '&make=' + filters.make : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %><%= filters.bodyType ? '&bodyType=' + filters.bodyType : '' %>" 
                     class="btn" style="padding: 0.5rem 1rem;">Next</a>
                <% } %>
              </div>
            <% } %>
          <% } %>

        </div>
      </section>

      <!-- 
        - #GET START
      -->
      <section class="section get-start">
        <div class="container">

          <h2 class="h2 section-title">Get started with 3 simple steps</h2>

          <ul class="get-start-list">
            <li>
              <div class="get-start-card">

                <div class="card-icon icon-1">
                  <ion-icon name="person-add-outline"></ion-icon>
                </div>

                <h3 class="card-title">Create a profile</h3>

                <p class="card-text">
                  If you are going to use a passage of Lorem Ipsum, you need to be sure.
                </p>

                <a href="#" class="card-link">Get started</a>

              </div>
            </li>
            <li>
              <div class="get-start-card">

                <div class="card-icon icon-1">
                  <ion-icon name="search-outline"></ion-icon>
                </div>

                <h3 class="card-title">Browse Verified Vehicles</h3>

                <p class="card-text">
                  Search our database of independently verified vehicles from certified ethical dealerships across SA.
                </p>

              </div>
            </li>

            <li>
              <div class="get-start-card">

                <div class="card-icon icon-2">
                  <ion-icon name="qr-code-outline"></ion-icon>
                </div>

                <h3 class="card-title">Scan QR Code</h3>

                <p class="card-text">
                  Each vehicle has a unique QR code providing instant access to verified service history and records.
                </p>

              </div>
            </li>

            <li>
              <div class="get-start-card">

                <div class="card-icon icon-3">
                  <ion-icon name="shield-checkmark-outline"></ion-icon>
                </div>

                <h3 class="card-title">Buy with Confidence</h3>

                <p class="card-text">
                  Make informed decisions with admin-verified data. Our dispute resolution system ensures accountability.
                </p>

              </div>
            </li>

          </ul>

        </div>
      </section>

      <!-- 
        - #BLOG
      -->

      <section class="section blog" id="blog">
        <div class="container">

          <h2 class="h2 section-title">Our Blog</h2>

          <ul class="blog-list has-scrollbar">

            <li>
              <div class="blog-card">

                <figure class="card-banner">

                  <a href="#">
                    <img src="./assets/images/blog-1.jpg" alt="How to verify a vehicle's history" loading="lazy"
                      class="w-100">
                  </a>

                  <a href="#" class="btn card-badge">Verification</a>

                </figure>

                <div class="card-content">

                  <h3 class="h3 card-title">
                    <a href="#">How to verify a vehicle's history</a>
                  </h3>

                  <div class="card-meta">

                    <div class="publish-date">
                      <ion-icon name="time-outline"></ion-icon>

                      <time datetime="2023-01-14">January 14, 2023</time>
                    </div>

                    <div class="comments">
                      <ion-icon name="chatbubble-ellipses-outline"></ion-icon>

                      <data value="23">23</data>
                    </div>

                  </div>

                </div>

              </div>
            </li>

            <li>
              <div class="blog-card">

                <figure class="card-banner">

                  <a href="#">
                    <img src="./assets/images/blog-2.jpg" alt="What to look for when buying a used car" loading="lazy"
                      class="w-100">
                  </a>

                  <a href="#" class="btn card-badge">Buying Guide</a>

                </figure>

                <div class="card-content">

                  <h3 class="h3 card-title">
                    <a href="#">What to look for when buying a used car</a>
                  </h3>

                  <div class="card-meta">

                    <div class="publish-date">
                      <ion-icon name="time-outline"></ion-icon>

                      <time datetime="2023-01-10">January 10, 2023</time>
                    </div>

                    <div class="comments">
                      <ion-icon name="chatbubble-ellipses-outline"></ion-icon>

                      <data value="42">42</data>
                    </div>

                  </div>

                </div>

              </div>
            </li>

            <li>
              <div class="blog-card">

                <figure class="card-banner">

                  <a href="#">
                    <img src="./assets/images/blog-3.jpg" alt="Benefits of certified dealerships" loading="lazy"
                      class="w-100">
                  </a>

                  <a href="#" class="btn card-badge">Dealerships</a>

                </figure>

                <div class="card-content">

                  <h3 class="h3 card-title">
                    <a href="#">Benefits of certified dealerships</a>
                  </h3>

                  <div class="card-meta">

                    <div class="publish-date">
                      <ion-icon name="time-outline"></ion-icon>

                      <time datetime="2022-12-28">December 28, 2022</time>
                    </div>

                    <div class="comments">
                      <ion-icon name="chatbubble-ellipses-outline"></ion-icon>

                      <data value="18">18</data>
                    </div>

                  </div>

                </div>

              </div>
            </li>

            <li>
              <div class="blog-card">

                <figure class="card-banner">

                  <a href="#">
                    <img src="./assets/images/blog-1.jpg" alt="How to verify a vehicle's history" loading="lazy"
                      class="w-100">
                  </a>

                  <a href="#" class="btn card-badge">Verification</a>

                </figure>

                <div class="card-content">

                  <h3 class="h3 card-title">
                    <a href="#">How to verify a vehicle's history</a>
                  </h3>

                  <div class="card-meta">

                    <div class="publish-date">
                      <ion-icon name="time-outline"></ion-icon>

                      <time datetime="2023-01-14">January 14, 2023</time>
                    </div>

                    <div class="comments">
                      <ion-icon name="chatbubble-ellipses-outline"></ion-icon>

                      <data value="23">23</data>
                    </div>

                  </div>

                </div>

              </div>
            </li>

            <li>
              <div class="blog-card">

                <figure class="card-banner">

                  <a href="#">
                    <img src="./assets/images/blog-2.jpg" alt="What to look for when buying a used car" loading="lazy"
                      class="w-100">
                  </a>

                  <a href="#" class="btn card-badge">Buying Guide</a>

                </figure>

                <div class="card-content">

                  <h3 class="h3 card-title">
                    <a href="#">What to look for when buying a used car</a>
                  </h3>

                  <div class="card-meta">

                    <div class="publish-date">
                      <ion-icon name="time-outline"></ion-icon>

                      <time datetime="2023-01-10">January 10, 2023</time>
                    </div>

                    <div class="comments">
                      <ion-icon name="chatbubble-ellipses-outline"></ion-icon>

                      <data value="42">42</data>
                    </div>

                  </div>

                </div>

              </div>
            </li>
          </ul>

        </div>
      </section>

    </article>
  </main>


  <script>
    'use strict';

    /**
     * navbar toggle
     */
    const overlay = document.querySelector("[data-overlay]");
    const navbar = document.querySelector("[data-navbar]");
    const navToggleBtn = document.querySelector("[data-nav-toggle-btn]");
    const navbarLinks = document.querySelectorAll("[data-nav-link]");

    const navToggleFunc = function () {
      navToggleBtn.classList.toggle("active");
      navbar.classList.toggle("active");
      overlay.classList.toggle("active");
    }

    navToggleBtn.addEventListener("click", navToggleFunc);
    overlay.addEventListener("click", navToggleFunc);

    for (let i = 0; i < navbarLinks.length; i++) {
      navbarLinks[i].addEventListener("click", navToggleFunc);
    }

    /**
     * header active on scroll
     */
    const header = document.querySelector("[data-header]");

    window.addEventListener("scroll", function () {
      window.scrollY >= 10 ? header.classList.add("active")
        : header.classList.remove("active");
    });
  </script>

  <!-- 
    - ionicon link
  -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const scanQrBtn = document.getElementById('scanQrBtn');
  const qrModal = document.getElementById('qrModal');
  const qrStatus = document.getElementById('qr-status');
  let html5QrcodeScanner;

  scanQrBtn.addEventListener('click', function() {
    qrModal.style.display = 'block';
    qrStatus.style.display = 'block';
    
    // Initialize scanner
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    
    // Request camera access and start scanning
    html5QrcodeScanner.start(
      { facingMode: "environment" }, // Use back camera on mobile
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      onQrCodeScanned,
      onQrCodeError
    );
    
    qrStatus.innerHTML = 'Camera ready - Point at QR code';
    qrStatus.style.background = '#d1fae5';
    qrStatus.style.color = '#065f46';
  });

  function onQrCodeScanned(qrCodeMessage) {
    qrStatus.innerHTML = '✓ QR code detected - Loading vehicle...';
    qrStatus.style.background = '#dbeafe';
    qrStatus.style.color = '#1e40af';
    
    try {
      let vin;
      
      // Try to parse as JSON first
      if (qrCodeMessage.startsWith('{')) {
        const parsed = JSON.parse(qrCodeMessage);
        vin = parsed.vin || parsed.VIN || parsed.vehicleId;
      } else {
        // Assume it's a raw VIN
        vin = qrCodeMessage;
      }
      
      if (!vin) {
        throw new Error('No VIN found in QR code');
      }
      
      // Stop scanner and redirect
      html5QrcodeScanner.stop().then(() => {
        // Redirect to vehicle details by VIN
        window.location.href = `/vehicle/vin/${vin.toUpperCase()}`;
      }).catch(err => {
        console.error('Error stopping scanner:', err);
        // Still redirect even if scanner stop fails
        window.location.href = `/vehicle/vin/${vin.toUpperCase()}`;
      });
      
    } catch (e) {
      qrStatus.innerHTML = '⚠ Error: ' + e.message;
      qrStatus.style.background = '#fee2e2';
      qrStatus.style.color = '#991b1b';
      
      // Try as raw VIN anyway
      setTimeout(() => {
        const vin = qrCodeMessage.toUpperCase();
        html5QrcodeScanner.stop().then(() => {
          window.location.href = `/vehicle/vin/${vin}`;
        });
      }, 2000);
    }
  }

  function onQrCodeError(errorMessage) {
    // Silently ignore scanning errors - it's normal while scanning
    // console.log('QR scanning error:', errorMessage);
  }

  window.closeQrModal = function() {
    qrModal.style.display = 'none';
    if (html5QrcodeScanner) {
      html5QrcodeScanner.stop().catch(err => {
        console.error('Error stopping scanner:', err);
      });
    }
  };

  // Close modal when clicking outside
  qrModal.addEventListener('click', function(e) {
    if (e.target === qrModal) {
      closeQrModal();
    }
  });

  // Close modal on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && qrModal.style.display === 'block') {
      closeQrModal();
    }
  });
</script>



</body>

</html>