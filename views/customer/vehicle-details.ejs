<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
</head>
<body>
  <%- include('../partials/header') %>
  
  <div class="container">
    <div style="margin-bottom: 20px;">
      <a href="/customer/vehicles" class="btn btn-secondary">
        <i class="ri-arrow-left-line"></i> Back to Vehicles
      </a>
    </div>
    
    <h1><%= vehicle.year %> <%= vehicle.make %> <%= vehicle.model %></h1>
    
    <!-- HERO SECTION WITH PRICE AND QR CODE -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 30px;">
        <div style="flex: 1; min-width: 280px;">
          <div class="vehicle-price" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 15px;">
            R <%= vehicle.price.toLocaleString() %>
          </div>
          <p style="font-size: 1.1rem; margin-bottom: 10px;">
            <i class="ri-building-line"></i> <strong><%= vehicle.business_name %></strong>
            <% if (vehicle.certification_status === 'active') { %>
              <span class="badge badge-success" style="margin-left: 10px;">
                <i class="ri-shield-check-fill"></i> Certified Dealership
              </span>
            <% } %>
          </p>
          <p style="font-size: 1rem; opacity: 0.9;">
            <i class="ri-roadster-line"></i> <%= vehicle.mileage.toLocaleString() %> km
            &nbsp;•&nbsp;
            <i class="ri-calendar-line"></i> <%= vehicle.year %>
            &nbsp;•&nbsp;
            <span style="text-transform: capitalize;"><%= vehicle.vehicle_status || 'Used' %></span>
          </p>
          <div style="margin-top: 15px;">
            <span class="badge badge-success" style="font-size: 1rem; padding: 8px 16px;">
              <i class="ri-verified-badge-fill"></i> Independently Verified
            </span>
          </div>
        </div>
        
        <% if (vehicle.qr_code_path) { %>
          <div style="text-align: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <p style="color: #374151; font-weight: 600; margin-bottom: 10px;">
              <i class="ri-qr-scan-2-line" style="color: var(--primary);"></i> 
              Scan for Instant History
            </p>
            <img src="<%= vehicle.qr_code_path %>" alt="Vehicle QR Code" style="max-width: 180px; border: 3px solid var(--primary); border-radius: 8px;">
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 8px;">
              Full verification details
            </p>
          </div>
        <% } %>
      </div>
    </div>
    
    <!-- VEHICLE IDENTIFICATION -->
    <div class="card">
      <h2><i class="ri-file-list-line"></i> Vehicle Identification</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
          <small style="color: #6b7280; display: block; margin-bottom: 5px; font-weight: 600;">VIN</small>
          <strong style="font-family: monospace; font-size: 1.1rem; color: var(--text);"><%= vehicle.vin %></strong>
        </div>
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
          <small style="color: #6b7280; display: block; margin-bottom: 5px; font-weight: 600;">Plate Number</small>
          <strong style="font-family: monospace; font-size: 1.1rem; color: var(--text);"><%= vehicle.plate_number %></strong>
        </div>
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid var(--primary);">
          <small style="color: #6b7280; display: block; margin-bottom: 5px; font-weight: 600;">Engine Number</small>
          <strong style="font-family: monospace; font-size: 1.1rem; color: var(--text);"><%= vehicle.engine_number %></strong>
        </div>
      </div>
    </div>
    
    <!-- VERIFICATION STATUS -->
    <div class="card" style="background: #ecfdf5; border-left: 4px solid var(--success);">
      <h2 style="color: var(--success);">
        <i class="ri-shield-check-fill"></i> Verification Details
      </h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
        <div>
          <p><strong>Status:</strong> <span class="badge badge-success">Verified</span></p>
          <p><strong>Verified Date:</strong> <%= new Date(vehicle.verified_at).toLocaleDateString() %></p>
          <% if (vehicle.verification_notes) { %>
            <p><strong>Admin Notes:</strong> <%= vehicle.verification_notes %></p>
          <% } %>
        </div>
        <div>
          <p style="color: #065f46; line-height: 1.6;">
            <i class="ri-information-line"></i> 
            This vehicle has been independently verified by our admin team. 
            All information displayed has been checked against official records and documentation.
          </p>
        </div>
      </div>
    </div>
    
    <!-- REGISTRATION & LEGAL INFORMATION -->
    <div class="card">
      <h2><i class="ri-file-list-3-line"></i> Registration & Legal Information</h2>
      <table class="table">
        <tr>
          <td style="width: 35%;"><strong>Registration Authority:</strong></td>
          <td style="width: 65%;"><%= vehicle.registration_authority || 'Not provided' %></td>
        </tr>
        <tr>
          <td><strong>Vehicle Status:</strong></td>
          <td style="text-transform: capitalize;">
            <%= vehicle.vehicle_status || 'Not provided' %>
            <% if (vehicle.vehicle_status === 'new') { %>
              <span class="badge badge-success">Brand New</span>
            <% } %>
          </td>
        </tr>
        <tr>
          <td><strong>Tare Weight:</strong></td>
          <td><%= vehicle.tare_weight ? vehicle.tare_weight + ' kg' : 'Not provided' %></td>
        </tr>
        <tr>
          <td><strong>Date Liable for Licensing:</strong></td>
          <td>
            <%= vehicle.date_liability_licensing ? new Date(vehicle.date_liability_licensing).toLocaleDateString() : 'Not provided' %>
            <% if (vehicle.date_liability_licensing) { %>
              <% const licensingDate = new Date(vehicle.date_liability_licensing); %>
              <% const today = new Date(); %>
              <% const daysUntil = Math.ceil((licensingDate - today) / (1000 * 60 * 60 * 24)); %>
              <% if (daysUntil < 0) { %>
                <span class="badge badge-danger">Overdue</span>
              <% } else if (daysUntil < 30) { %>
                <span class="badge badge-warning">Due Soon</span>
              <% } else { %>
                <span class="badge badge-success">Current</span>
              <% } %>
            <% } %>
          </td>
        </tr>
        <tr>
          <td><strong>Date Liable for Registration:</strong></td>
          <td>
            <%= vehicle.date_liable_registration ? new Date(vehicle.date_liable_registration).toLocaleDateString() : 'Not provided' %>
          </td>
        </tr>
        <tr>
          <td><strong>Number of Previous Owners:</strong></td>
          <td>
            <%= vehicle.previous_owners %>
            <% if (vehicle.previous_owners === 0) { %>
              <span class="badge badge-success">First Owner</span>
            <% } else if (vehicle.previous_owners === 1) { %>
              <span class="badge badge-info">One Previous Owner</span>
            <% } %>
          </td>
        </tr>
      </table>
      
      <% if (vehicle.license_numbers) { %>
        <% try { %>
          <% const licenseNums = JSON.parse(vehicle.license_numbers); %>
          <% if (licenseNums.length > 0) { %>
            <h3 style="margin-top: 25px; color: var(--primary);">
              <i class="ri-file-copy-line"></i> License Number History
            </h3>
            <p style="color: #6b7280; margin-bottom: 15px;">
              Previous license plate numbers for this vehicle (most recent first)
            </p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <% licenseNums.forEach((num, index) => { %>
                <div style="padding: 12px 20px; background: <%= index === 0 ? '#dbeafe' : '#f3f4f6' %>; border-radius: 8px; border-left: 4px solid <%= index === 0 ? 'var(--primary)' : '#d1d5db' %>;">
                  <small style="display: block; color: #6b7280; font-weight: 600; margin-bottom: 4px;">
                    <%= index === 0 ? 'CURRENT LICENSE' : `PREVIOUS ${index}` %>
                  </small>
                  <strong style="font-family: monospace; font-size: 1.2rem; color: var(--text);"><%= num %></strong>
                </div>
              <% }); %>
            </div>
          <% } %>
        <% } catch(e) { %>
          <!-- Error parsing license numbers -->
        <% } %>
      <% } %>
    </div>
    
    <!-- VEHICLE SPECIFICATIONS -->
    <div class="card">
      <h2><i class="ri-car-line"></i> Vehicle Specifications</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px;">
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Make</small>
          <strong><%= vehicle.make %></strong>
        </div>
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Model</small>
          <strong><%= vehicle.model %></strong>
        </div>
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Year</small>
          <strong><%= vehicle.year %></strong>
        </div>
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Color</small>
          <strong><%= vehicle.color || 'Not specified' %></strong>
        </div>
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Body Type</small>
          <strong><%= vehicle.body_type || 'Not specified' %></strong>
        </div>
        <div style="padding: 12px; background: #f9fafb; border-radius: 6px;">
          <small style="color: #6b7280; display: block; margin-bottom: 4px;">Transmission</small>
          <strong><%= vehicle.transmission || 'Not specified' %></strong>
        </div>
      </div>
    </div>
    
    <!-- ENGINE & FUEL SPECIFICATIONS -->
    <div class="card">
      <h2><i class="ri-settings-3-line"></i> Engine & Fuel Specifications</h2>
      <table class="table">
        <tr>
          <td style="width: 35%;"><strong>Engine Type:</strong></td>
          <td style="width: 65%;"><%= vehicle.engine_type || 'Not provided' %></td>
        </tr>
        <tr>
          <td><strong>Engine Capacity:</strong></td>
          <td><%= vehicle.engine_capacity || 'Not provided' %></td>
        </tr>
        <tr>
          <td><strong>Fuel Type:</strong></td>
          <td>
            <%= vehicle.fuel_type || 'Not provided' %>
            <% if (vehicle.fuel_type === 'Electric') { %>
              <span class="badge badge-success">
                <i class="ri-leaf-line"></i> Zero Emissions
              </span>
            <% } else if (vehicle.fuel_type === 'Hybrid' || vehicle.fuel_type === 'Plug-in Hybrid') { %>
              <span class="badge badge-info">
                <i class="ri-leaf-line"></i> Eco-Friendly
              </span>
            <% } %>
          </td>
        </tr>
      </table>
    </div>
    
    <!-- MILEAGE VERIFICATION -->
    <div class="card">
      <h2><i class="ri-dashboard-3-line"></i> Mileage Information</h2>
      <div style="display: flex; align-items: center; gap: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--primary);">
        <div style="font-size: 3rem; color: var(--primary);">
          <i class="ri-speed-fill"></i>
        </div>
        <div>
          <p style="font-size: 2rem; font-weight: 700; color: var(--text); margin: 0;">
            <%= vehicle.mileage.toLocaleString() %> km
          </p>
          <p style="color: #1e40af; margin: 5px 0 0 0;">
            <i class="ri-checkbox-circle-fill"></i> Mileage verified against service records
          </p>
        </div>
      </div>
    </div>
    
    <!-- VEHICLE HISTORY REPORT -->
    <div class="card">
      <h2><i class="ri-file-history-line"></i> Complete Vehicle History Report</h2>
      
      <div style="margin-top: 20px;">
        <h3 style="color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <i class="ri-tools-line"></i> Service History
          <% if (vehicle.service_history_verified) { %>
            <span class="badge badge-success">
              <i class="ri-checkbox-circle-fill"></i> Verified
            </span>
          <% } %>
        </h3>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; line-height: 1.8;">
          <%= vehicle.service_history || 'Not provided' %>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <h3 style="color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <i class="ri-alarm-warning-line"></i> Accident History
          <% if (vehicle.accident_history_verified) { %>
            <span class="badge badge-success">
              <i class="ri-checkbox-circle-fill"></i> Verified
            </span>
          <% } %>
        </h3>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; line-height: 1.8;">
          <%= vehicle.accident_history || 'Not provided' %>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <h3 style="color: var(--primary); display: flex; align-items: center; gap: 8px;">
          <i class="ri-error-warning-line"></i> Recall Information
          <% if (vehicle.recall_verified) { %>
            <span class="badge badge-success">
              <i class="ri-checkbox-circle-fill"></i> Verified
            </span>
          <% } %>
        </h3>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; line-height: 1.8;">
          <%= vehicle.recall_information || 'Not provided' %>
        </div>
      </div>
    </div>
    
    <!-- ADDITIONAL FEATURES -->
    <% if (vehicle.additional_features) { %>
      <div class="card">
        <h2><i class="ri-star-line"></i> Additional Features</h2>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; line-height: 1.8;">
          <%= vehicle.additional_features %>
        </div>
      </div>
    <% } %>
    
    <!-- VEHICLE DESCRIPTION -->
    <% if (vehicle.description) { %>
      <div class="card">
        <h2><i class="ri-file-text-line"></i> Vehicle Description</h2>
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 10px; white-space: pre-wrap; line-height: 1.8;">
          <%= vehicle.description %>
        </div>
      </div>
    <% } %>
    
    <!-- DEALERSHIP CONTACT INFORMATION -->
    <div class="card" style="border: 2px solid var(--primary);">
      <h2><i class="ri-building-line"></i> Contact Dealership</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
        <div>
          <h3 style="color: var(--primary); margin-bottom: 10px;"><%= vehicle.business_name %></h3>
          <p><i class="ri-phone-line"></i> <strong>Phone:</strong> <%= vehicle.phone %></p>
          <p><i class="ri-mail-line"></i> <strong>Email:</strong> <%= vehicle.email %></p>
          <% if (vehicle.website) { %>
            <p><i class="ri-global-line"></i> <strong>Website:</strong> <a href="<%= vehicle.website %>" target="_blank"><%= vehicle.website %></a></p>
          <% } %>
        </div>
        <div>
          <% if (vehicle.certification_status === 'active') { %>
            <div style="padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid var(--success);">
              <p style="margin: 0; color: #065f46; font-weight: 600;">
                <i class="ri-verified-badge-fill" style="color: var(--success);"></i> 
                Certified Ethical Dealership
              </p>
              <p style="margin: 8px 0 0 0; color: #047857; font-size: 0.9rem;">
                This dealership has been verified and certified by Before You Sign for transparency and ethical practices.
              </p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    
    <!-- REPORT DISCREPANCY SECTION -->
    <div class="card" style="background: #fef3c7; border-left: 4px solid var(--warning);">
      <h2 style="color: #92400e;">
        <i class="ri-alert-line"></i> Found an Issue?
      </h2>
      <p style="color: #78350f; line-height: 1.6; margin-top: 10px;">
        If you find any discrepancies in the vehicle information or have concerns about this listing, 
        you can report it through our dispute resolution system. We take all reports seriously and 
        will investigate thoroughly.
      </p>
      <div style="margin-top: 20px;">
        <% if (role === 'customer') { %>
          <a href="/customer/report-dispute?vehicleId=<%= vehicle.id %>" class="btn btn-danger" style="font-size: 1rem; padding: 12px 24px;">
            <i class="ri-error-warning-line"></i> Report Discrepancy
          </a>
        <% } else { %>
          <a href="/login?redirect=/customer/report-dispute?vehicleId=<%= vehicle.id %>" class="btn btn-danger" style="font-size: 1rem; padding: 12px 24px;">
            <i class="ri-login-box-line"></i> Login to Report Issue
          </a>
        <% } %>
      </div>
    </div>
    
    <!-- BACK TO BROWSING -->
    <div style="margin-top: 30px; text-align: center;">
      <a href="/customer/vehicles" class="btn btn-primary" style="font-size: 1rem; padding: 12px 30px;">
        <i class="ri-arrow-left-line"></i> Continue Browsing Vehicles
      </a>
    </div>
  </div>
  
  <%- include('../partials/footer') %>
</body>
</html>
